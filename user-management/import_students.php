<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
include '../PHP/dbcon.php'; // Adjust path as necessary for your db connection
session_start();

// Function to generate a random password
function generateRandomPassword($length = 12) {
    $characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%^&*()_+';
    $password = '';
    for ($i = 0; $i < $length; $i++) {
        $password .= $characters[random_int(0, strlen($characters) - 1)];
    }
    return $password;
}

// Function to log actions in user_management_history
function log_user_action($conn, $action_type, $target_user_type, $target_user_identifier, $details = null) {
    // Get admin ID and name from session for history logging
    $admin_id = $_SESSION['admin_id'] ?? 0;
    $admin_name = $_SESSION['admin_name'] ?? 'System/Unknown';

    $action_type = mysqli_real_escape_string($conn, $action_type);
    $target_user_type = mysqli_real_escape_string($conn, $target_user_type);
    $target_user_identifier = mysqli_real_escape_string($conn, $target_user_identifier);
    $details = $details ? mysqli_real_escape_string($conn, $details) : 'N/A';

    $query = "INSERT INTO user_management_history (performed_by_admin_id, performed_by_admin_name, action_type, target_user_type, target_user_identifier, details) VALUES (?, ?, ?, ?, ?, ?)";
    $stmt = mysqli_prepare($conn, $query);

    if ($stmt) {
        mysqli_stmt_bind_param($stmt, "isssss", $admin_id, $admin_name, $action_type, $target_user_type, $target_user_identifier, $details);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_close($stmt);
    } else {
        error_log("Failed to prepare log statement: " . mysqli_error($conn));
    }
}

// Ensure this script is only accessible by authorized admins
if (!isset($_SESSION['admin_id'])) {
    echo json_encode(['success' => false, 'message' => 'Unauthorized access.']);
    exit();
}

header('Content-Type: application/json');
$response = ['success' => false, 'message' => ''];
$admin_name = $_SESSION['admin_name'] ?? 'Admin'; // Get admin name from session for history logging

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv_file'])) {
    $csvFile = $_FILES['csv_file']['tmp_name'];
    $fileType = mime_content_type($csvFile);
    $fileName = $_FILES['csv_file']['name'];
    $fileExtension = pathinfo($fileName, PATHINFO_EXTENSION);

    // Basic validation for file type (CSV or common Excel types)
    $allowedMimeTypes = [
        'text/csv',
        'application/vnd.ms-excel', // .xls
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' // .xlsx
    ];

    if (!in_array($fileType, $allowedMimeTypes)) {
        $response['message'] = 'Invalid file type. Please upload a CSV or Excel file (.csv, .xls, .xlsx).';
        echo json_encode($response);
        exit();
    }

    // Placeholder for XLSX parsing.
    // To properly handle XLSX, you would need a library like PhpSpreadsheet.
    // Example: require 'vendor/autoload.php';
    // Use PhpOffice\PhpSpreadsheet\IOFactory;
    // $spreadsheet = IOFactory::load($csvFile);
    // $sheetData = $spreadsheet->getActiveSheet()->toArray(null, true, true, true);
    // For this demonstration, we'll assume CSV parsing or simplified Excel handling.
    // If it's an XLSX, you'd integrate the library here to get sheet data in a similar format to fgetcsv.

    if (($handle = fopen($csvFile, "r")) !== FALSE) {
        $header = fgetcsv($handle, 1000, ",");

        // Expected headers based on the new CSV format
        $expectedHeaders = [
            'student_number', 'first_name', 'middle_name', 'last_name', 'email',
            'course_id', 'year_id', 'section_id', 'gender_id'
        ];

        // Check if all required headers are present (case-insensitive and trimmed for robustness)
        $normalizedHeader = array_map(function($h) { return strtolower(trim($h)); }, $header);
        $normalizedExpectedHeaders = array_map(function($h) { return strtolower(trim($h)); }, $expectedHeaders);

        $missingHeaders = array_diff($normalizedExpectedHeaders, $normalizedHeader);
        if (!empty($missingHeaders)) {
            $response['message'] = 'Missing required CSV/Excel headers: ' . implode(', ', $missingHeaders) . '. Please ensure your file matches the template.';
            fclose($handle);
            echo json_encode($response);
            exit();
        }

        $importedCount = 0;
        $failedEntries = [];
        // Create a mapping from cleaned CSV header to original index for data retrieval
        $columnMapping = [];
        foreach ($header as $index => $colName) {
            $columnMapping[strtolower(trim($colName))] = $index;
        }

        // Start transaction for atomicity
        mysqli_begin_transaction($conn);
        $errorsOccurredDuringTransaction = false; // Flag for critical errors that should trigger a rollback

        while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {
            // Ensure row has enough columns based on the mapped header indices
            $num_columns = count($data);
            foreach ($columnMapping as $colName => $idx) {
                if ($idx >= $num_columns && !in_array($colName, ['middle_name'])) { // middle_name is optional
                    $failedEntries[] = "Skipped row due to incomplete data for row: " . implode(', ', $data);
                    $errorsOccurredDuringTransaction = true;
                    continue 2; // Skip to next row in the outer while loop
                }
            }

            // Get data using the robust column mapping
            $student_number = mysqli_real_escape_string($conn, $data[$columnMapping['student_number']] ?? '');
            $first_name = mysqli_real_escape_string($conn, $data[$columnMapping['first_name']] ?? '');
            $middle_name = mysqli_real_escape_string($conn, $data[$columnMapping['middle_name']] ?? '');
            $last_name = mysqli_real_escape_string($conn, $data[$columnMapping['last_name']] ?? '');
            $email = mysqli_real_escape_string($conn, $data[$columnMapping['email']] ?? '');

            // Optional fields, safely cast to int, default to 0 if not provided or invalid
            $course_id = (int)($data[$columnMapping['course_id']] ?? 0);
            $year_id = (int)($data[$columnMapping['year_id']] ?? 0);
            $section_id = (int)($data[$columnMapping['section_id']] ?? 0);
            $gender_id = (int)($data[$columnMapping['gender_id']] ?? 0);

            // Auto-fill status_id to 'Active' (ID 1) and roles_id to 'Student' (ID 2)
            $status_id = 1; // Assuming 1 is 'Active' in status_tbl
            $roles_id = 2; // Assuming 2 is 'Student' in roles_tbl

            // --- Validation for critical fields ---
            if (empty($student_number) || empty($first_name) || empty($last_name) || empty($email)) {
                $failedEntries[] = "Skipped row due to missing critical data (Student Number, First Name, Last Name, or Email) for row: " . implode(', ', $data);
                $errorsOccurredDuringTransaction = true; // Mark as an error that might require rollback for this row
                continue; // Skip to next row
            }

            // --- Check for existing student number or email to prevent duplicates ---
            $check_query = "SELECT student_number, email FROM users_tbl WHERE student_number = ? OR email = ?";
            $check_stmt = mysqli_prepare($conn, $check_query);
            mysqli_stmt_bind_param($check_stmt, "ss", $student_number, $email);
            mysqli_stmt_execute($check_stmt);
            mysqli_stmt_store_result($check_stmt);

            if (mysqli_stmt_num_rows($check_stmt) > 0) {
                $failedEntries[] = "Duplicate entry skipped: Student Number '{$student_number}' or Email '{$email}' already exists.";
                mysqli_stmt_close($check_stmt);
                continue; // Skip to next row
            }
            mysqli_stmt_close($check_stmt);

            // --- Generate Password ---
            $generated_password = generateRandomPassword();
            $hashed_password = password_hash($generated_password, PASSWORD_DEFAULT);

            // Set new_until timestamp (current time + 1 hour)
            $new_until_timestamp = date('Y-m-d H:i:s', strtotime('+1 hour'));


            // --- Insert into users_tbl ---
            $insert_query = "INSERT INTO users_tbl (student_number, first_name, middle_name, last_name, email, password_hash, course_id, year_id, section_id, gender_id, status_id, roles_id, new_until) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
            $stmt = mysqli_prepare($conn, $insert_query);

            if ($stmt) {
                mysqli_stmt_bind_param($stmt, "ssssssiiiisds", // s:string, i:integer, d:double (for datetime if needed, but s works for formatted string)
                    $student_number, $first_name, $middle_name, $last_name, $email, $hashed_password,
                    $course_id, $year_id, $section_id, $gender_id, $status_id, $roles_id, $new_until_timestamp
                );

                if (mysqli_stmt_execute($stmt)) {
                    $importedCount++;

                    // --- Send Email with Generated Password (PLACEHOLDER) ---
                    // IMPORTANT: For production, you should use a robust email library like PHPMailer or Swift Mailer
                    // and configure SMTP settings. The basic mail() function might not be reliable.
                    /*
                    $to = $email;
                    $subject = "Your New Student Account Password";
                    $message = "Dear " . htmlspecialchars($first_name) . ",<br><br>"
                             . "Your new student account has been created. Your credentials are:<br>"
                             . "Student Number: <b>" . htmlspecialchars($student_number) . "</b><br>"
                             . "Email (Username): <b>" . htmlspecialchars($email) . "</b><br>"
                             . "Temporary Password: <b>" . htmlspecialchars($generated_password) . "</b><br><br>"
                             . "Please log in and change your password immediately.<br><br>"
                             . "Regards,<br>Your University Admin Team";
                    $headers = "MIME-Version: 1.0" . "\r\n";
                    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
                    $headers .= 'From: <noreply@youruniversity.com>' . "\r\n";
                    
                    // Attempt to send email. Add more robust error handling if needed.
                    if (!mail($to, $subject, $message, $headers)) {
                        error_log("Failed to send email to {$email} for student {$student_number}");
                        $failedEntries[] = "Failed to send email to {$email} for student {$student_number}.";
                    }
                    */

                    // Log the action in user_management_history
                    $details = "Imported student: <b>" . htmlspecialchars($first_name) . " " . htmlspecialchars($last_name) . "</b> (Student No: " . htmlspecialchars($student_number) . "). Password system-generated and sent to email.";

                    // Check for missing optional data and append to details for logging
                    $missing_optional_info = [];
                    if ($course_id === 0) $missing_optional_info[] = "Course";
                    if ($year_id === 0) $missing_optional_info[] = "Year";
                    if ($section_id === 0) $missing_optional_info[] = "Section";
                    if ($gender_id === 0) $missing_optional_info[] = "Gender";

                    if (!empty($missing_optional_info)) {
                        $details .= " Missing: " . implode(', ', $missing_optional_info) . ".";
                    }

                    log_user_action($conn, "Import Student", "Student", $student_number, $details);

                } else {
                    $failedEntries[] = "Failed to insert row for student number {$student_number}: " . mysqli_error($conn);
                    $errorsOccurredDuringTransaction = true;
                }
                mysqli_stmt_close($stmt);
            } else {
                $failedEntries[] = "Failed to prepare insert statement for student number {$student_number}: " . mysqli_error($conn);
                $errorsOccurredDuringTransaction = true;
            }
        }
        fclose($handle);

        // Commit or Rollback transaction
        if ($errorsOccurredDuringTransaction) {
            mysqli_rollback($conn);
            $response['success'] = false; // Indicate overall failure if critical errors occurred
            $response['message'] = "Import completed with errors. All changes have been rolled back. " . (!empty($failedEntries) ? "Errors: " . implode('; ', $failedEntries) : "");
        } else {
            mysqli_commit($conn);
            $response['success'] = true;
            $response['message'] = "Successfully imported $importedCount students.";
            if (!empty($failedEntries)) {
                $response['message'] .= " Some entries had missing optional data or warnings: " . implode('; ', $failedEntries);
            }
        }
    } else {
        $response['message'] = 'Error opening CSV file.';
    }
} else {
    $response['message'] = 'No CSV file uploaded or invalid request method.';
}

echo json_encode($response);
exit();
?>